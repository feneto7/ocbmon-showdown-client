{"version":3,"file":"client-connection.js","names":["PSConnection","socket","connected","queue","connect","_proto","prototype","_this","server","PS","port","protocol","httpport","url","host","prefix","SockJS","timeout","onopen","console","log","_i2","_this$queue2","length","msg","send","update","onmessage","e","receive","data","onclose","isOffline","roomid","rooms","disconnect","close","connection","push","PSLoginServer","_class","_proto2","query","id","location","pathname","endsWith","Config","routes","clientProtocol","client","POKEMON_SHOWDOWN_TESTCLIENT_KEY","sid","replace","Net","get","method","body","then","res","JSON","parse","slice","HttpError","_Error","message","statusCode","_this2","call","name","Error","captureStackTrace","err","_inheritsLoose","_wrapNativeSuper","NetRequest","uri","_proto3","_this3","opts","arguments","undefined","Promise","resolve","reject","xhr","XMLHttpRequest","includes","encodeQuery","open","onreadystatechange","DONE","readyState","status","responseText","statusText","setRequestHeader","post","Object","assign","urlencodedData","key","encodeURIComponent"],"sources":["../src/client-connection.ts"],"sourcesContent":["/**\r\n * Connection library\r\n *\r\n * @author Guangcong Luo <guangcongluo@gmail.com>\r\n * @license MIT\r\n */\r\n\r\ndeclare var SockJS: any;\r\n\r\nclass PSConnection {\r\n\tsocket: any = null;\r\n\tconnected = false;\r\n\tqueue = [] as string[];\r\n\tconstructor() {\r\n\t\tthis.connect();\r\n\t}\r\n\tconnect() {\r\n\t\tconst server = PS.server;\r\n\t\tconst port = ':' + server.protocol === 'https' ? server.port : server.httpport;\r\n\t\tconst url = server.protocol + '://' + server.host + port + server.prefix;\r\n\t\tconst socket = this.socket = new SockJS(url, [], {timeout: 5 * 60 * 1000});\r\n\t\tsocket.onopen = () => {\r\n\t\t\tconsole.log('\\u2705 (CONNECTED)');\r\n\t\t\tthis.connected = true;\r\n\t\t\tPS.connected = true;\r\n\t\t\tfor (const msg of this.queue) socket.send(msg);\r\n\t\t\tthis.queue = [];\r\n\t\t\tPS.update();\r\n\t\t};\r\n\t\tsocket.onmessage = (e: MessageEvent) => {\r\n\t\t\tPS.receive('' + e.data);\r\n\t\t};\r\n\t\tsocket.onclose = () => {\r\n\t\t\tconsole.log('\\u2705 (DISCONNECTED)');\r\n\t\t\tthis.connected = false;\r\n\t\t\tPS.connected = false;\r\n\t\t\tPS.isOffline = true;\r\n\t\t\tfor (const roomid in PS.rooms) {\r\n\t\t\t\tPS.rooms[roomid]!.connected = false;\r\n\t\t\t}\r\n\t\t\tthis.socket = null;\r\n\t\t\tPS.update();\r\n\t\t};\r\n\t}\r\n\tdisconnect() {\r\n\t\tthis.socket.close();\r\n\t\tPS.connection = null;\r\n\t}\r\n\tsend(msg: string) {\r\n\t\tif (!this.connected) {\r\n\t\t\tthis.queue.push(msg);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.socket.send(msg);\r\n\t}\r\n}\r\n\r\nPS.connection = new PSConnection();\r\n\r\nconst PSLoginServer = new class {\r\n\tquery(data: PostData): Promise<{[k: string]: any} | null> {\r\n\t\tlet url = '/~~' + PS.server.id + '/action.php';\r\n\t\tif (location.pathname.endsWith('.html')) {\r\n\t\t\turl = Config.routes.clientProtocol + '://' + Config.routes.client + url;\r\n\t\t\t// @ts-ignore\r\n\t\t\tif (typeof POKEMON_SHOWDOWN_TESTCLIENT_KEY === 'string') {\r\n\t\t\t\t// @ts-ignore\r\n\t\t\t\tdata.sid = POKEMON_SHOWDOWN_TESTCLIENT_KEY.replace(/\\%2C/g, ',');\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn Net(url).get({method: data ? 'POST' : 'GET', body: data}).then(\r\n\t\t\tres => res ? JSON.parse(res.slice(1)) : null\r\n\t\t).catch(\r\n\t\t\t() => null\r\n\t\t);\r\n\t}\r\n};\r\n\r\ninterface PostData {\r\n\t[key: string]: string | number;\r\n}\r\ninterface NetRequestOptions {\r\n\tmethod?: 'GET' | 'POST';\r\n\tbody?: string | PostData;\r\n\tquery?: PostData;\r\n}\r\nclass HttpError extends Error {\r\n\tstatusCode?: number;\r\n\tbody: string;\r\n\tconstructor(message: string, statusCode: number | undefined, body: string) {\r\n\t\tsuper(message);\r\n\t\tthis.name = 'HttpError';\r\n\t\tthis.statusCode = statusCode;\r\n\t\tthis.body = body;\r\n\t\ttry {\r\n\t\t\t(Error as any).captureStackTrace(this, HttpError);\r\n\t\t} catch (err) {}\r\n\t}\r\n}\r\nclass NetRequest {\r\n\turi: string;\r\n\tconstructor(uri: string) {\r\n\t\tthis.uri = uri;\r\n\t}\r\n\r\n\t/**\r\n\t * Makes a basic http/https request to the URI.\r\n\t * Returns the response data.\r\n\t *\r\n\t * Will throw if the response code isn't 200 OK.\r\n\t *\r\n\t * @param opts request opts\r\n\t */\r\n\tget(opts: NetRequestOptions = {}): Promise<string> {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst xhr = new XMLHttpRequest();\r\n\t\t\tlet uri = this.uri;\r\n\t\t\tif (opts.query) {\r\n\t\t\t\turi += (uri.includes('?') ? '&' : '?') + Net.encodeQuery(opts.query);\r\n\t\t\t}\r\n\t\t\txhr.open(opts.method || 'GET', uri);\r\n\t\t\txhr.onreadystatechange = function () {\r\n\t\t\t\tconst DONE = 4;\r\n\t\t\t\tif (xhr.readyState === DONE) {\r\n\t\t\t\t\tif (xhr.status === 200) {\r\n\t\t\t\t\t\tresolve(xhr.responseText || '');\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst err = new HttpError(xhr.statusText || \"Connection error\", xhr.status, xhr.responseText);\r\n\t\t\t\t\treject(err);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tif (opts.body) {\r\n\t\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\r\n\t\t\t\txhr.send(Net.encodeQuery(opts.body));\r\n\t\t\t} else {\r\n\t\t\t\txhr.send();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Makes a http/https POST request to the given link.\r\n\t * @param opts request opts\r\n\t * @param body POST body\r\n\t */\r\n\tpost(opts: Omit<NetRequestOptions, 'body'>, body: PostData | string): Promise<string>;\r\n\t/**\r\n\t * Makes a http/https POST request to the given link.\r\n\t * @param opts request opts\r\n\t */\r\n\tpost(opts?: NetRequestOptions): Promise<string>;\r\n\tpost(opts: NetRequestOptions = {}, body?: PostData | string) {\r\n\t\tif (!body) body = opts.body;\r\n\t\treturn this.get({\r\n\t\t\t...opts,\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction Net(uri: string) {\r\n\treturn new NetRequest(uri);\r\n}\r\n\r\nNet.encodeQuery = function (data: string | PostData) {\r\n\tif (typeof data === 'string') return data;\r\n\tlet urlencodedData = '';\r\n\tfor (const key in data) {\r\n\t\tif (urlencodedData) urlencodedData += '&';\r\n\t\turlencodedData += encodeURIComponent(key) + '=' + encodeURIComponent((data as any)[key]);\r\n\t}\r\n\treturn urlencodedData;\r\n};\r\n"],"mappings":"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","ignoreList":[]}